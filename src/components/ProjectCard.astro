---
import Link from '@/components/Link.astro'
import { Badge } from '@/components/ui/badge'
import { formatDate } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import { Image } from 'astro:assets'
import type { CollectionEntry } from 'astro:content'

interface Props {
  project: CollectionEntry<'projects' | 'ctfProjects'>
}

const { project } = Astro.props
const isCtfProject = project.collection === 'ctfProjects'
const link = project.data.link
const isLinkDisabled = isCtfProject || !link
const imageLight = project.data.imageLight
const imageDark = project.data.imageDark
const image = project.data.image
const hasDetails =
  !!project.data.target || !!project.data.affiliation
const showDate = !!project.data.startDate
const highlights = project.data.highlights ?? []
const formatCtfRange = () => {
  if (!project.data.startDate) return ''
  const start = formatDate(project.data.startDate)
  const end = project.data.endDate ? formatDate(project.data.endDate) : 'Present'
  return `${start} → ${end}`
}
const formatProjectRange = () => {
  if (!project.data.startDate) return ''
  const start = formatMonthYear(project.data.startDate)
  const end = project.data.endDate ? formatMonthYear(project.data.endDate) : 'Present'
  return `${start} → ${end}`
}
const formatMonthYear = (date: Date) =>
  new Intl.DateTimeFormat('en-US', {
    month: 'short',
    year: 'numeric',
  }).format(date)
const imageWrapperClass =
  'bg-muted/30 flex h-24 w-full items-center justify-center overflow-hidden rounded-md border'
const layoutClass =
  'grid w-full gap-4 text-left sm:grid-cols-[10rem_1fr] sm:items-start'
---

<div
  class="hover:bg-muted/50 rounded-xl border p-4 transition-colors duration-300 ease-in-out"
>
  {
    isCtfProject ? (
      <a
        href={`/ctf/tags/${encodeURIComponent(project.data.name)}`}
        class={layoutClass}
      >
        {
          imageLight && imageDark ? (
            <div class={imageWrapperClass}>
              <Image
                src={imageLight}
                alt={project.data.name}
                width={1200}
                height={630}
                class="object-contain dark:hidden"
              />
              <Image
                src={imageDark}
                alt={project.data.name}
                width={1200}
                height={630}
                class="hidden object-contain dark:block"
              />
            </div>
          ) : (
            image && (
              <div class={imageWrapperClass}>
                <Image
                  src={image}
                  alt={project.data.name}
                  width={1200}
                  height={630}
                  class="object-contain"
                />
              </div>
            )
          )
        }
        <div class="grow">
          <h3 class="mb-1 text-lg font-medium">
            {project.data.name}
          </h3>
          {
            project.data.description && (
              <p class="text-muted-foreground mb-2 text-sm">
                {project.data.description}
              </p>
            )
          }
          {
            highlights.length > 0 && (
              <p class="text-muted-foreground mt-2 text-xs">
                {highlights.join(' · ')}
              </p>
            )
          }
          {
            showDate && (
              <p class="text-muted-foreground/70 mt-2 flex items-center gap-x-1.5 text-xs">
                <Icon name="lucide:calendar" class="size-3" />
                <span>{formatCtfRange()}</span>
              </p>
            )
          }
          {
            project.data.tags && (
              <div class="mt-2 flex flex-wrap gap-2">
                {project.data.tags.map((tag: string) => (
                  <Badge variant="muted">{tag}</Badge>
                ))}
              </div>
            )
          }
        </div>
      </a>
    ) : isLinkDisabled ? (
      <div class={layoutClass}>
        {
          imageLight && imageDark ? (
            <div class={imageWrapperClass}>
              <Image
                src={imageLight}
                alt={project.data.name}
                width={1200}
                height={630}
                class="object-contain dark:hidden"
              />
              <Image
                src={imageDark}
                alt={project.data.name}
                width={1200}
                height={630}
                class="hidden object-contain dark:block"
              />
            </div>
          ) : (
            image && (
              <div class={imageWrapperClass}>
                <Image
                  src={image}
                  alt={project.data.name}
                  width={1200}
                  height={630}
                  class="object-contain"
                />
              </div>
            )
          )
        }
        <div class="grow">
          <h3 class="mb-1 text-lg font-medium">
            {project.data.name}
          </h3>
          {
            project.data.description && (
              <p class="text-muted-foreground mb-2 text-sm">
                {project.data.description}
              </p>
            )
          }
          {
            highlights.length > 0 && (
              <p class="text-muted-foreground mt-2 text-xs">
                {highlights.join(' · ')}
              </p>
            )
          }
          {
            hasDetails && (
              <dl class="text-muted-foreground mt-2 grid grid-cols-[6.5rem_1fr] gap-x-3 gap-y-1 text-xs">
                {project.data.target && (
                  <>
                    <dt>Target</dt>
                    <dd>{project.data.target}</dd>
                  </>
                )}
                {project.data.affiliation && (
                  <>
                    <dt>Affiliation</dt>
                    <dd>{project.data.affiliation}</dd>
                  </>
                )}
              </dl>
            )
          }
          {
            showDate && (
              <p class="text-muted-foreground/70 mt-2 flex items-center gap-x-1.5 text-xs">
                <Icon name="lucide:calendar" class="size-3" />
                <span>
                  {formatProjectRange()}
                </span>
              </p>
            )
          }
          {
            project.data.tags && (
              <div class="mt-2 flex flex-wrap gap-2">
                {project.data.tags.map((tag: string) => (
                  <Badge variant="muted">{tag}</Badge>
                ))}
              </div>
            )
          }
        </div>
      </div>
    ) : (
      <Link
        href={link!}
        class={layoutClass}
        external
      >
        {
          imageLight && imageDark ? (
            <div class={imageWrapperClass}>
              <Image
                src={imageLight}
                alt={project.data.name}
                width={1200}
                height={630}
                class="object-contain dark:hidden"
              />
              <Image
                src={imageDark}
                alt={project.data.name}
                width={1200}
                height={630}
                class="hidden object-contain dark:block"
              />
            </div>
          ) : (
            image && (
              <div class={imageWrapperClass}>
                <Image
                  src={image}
                  alt={project.data.name}
                  width={1200}
                  height={630}
                  class="object-contain"
                />
              </div>
            )
          )
        }
        <div class="grow">
          <h3 class="mb-1 text-lg font-medium">
            {project.data.name}
          </h3>
          {
            project.data.description && (
              <p class="text-muted-foreground mb-2 text-sm">
                {project.data.description}
              </p>
            )
          }
          {
            highlights.length > 0 && (
              <p class="text-muted-foreground mt-2 text-xs">
                {highlights.join(' · ')}
              </p>
            )
          }
          {
            hasDetails && (
              <dl class="text-muted-foreground mt-2 grid grid-cols-[6.5rem_1fr] gap-x-3 gap-y-1 text-xs">
                {project.data.target && (
                  <>
                    <dt>Target</dt>
                    <dd>{project.data.target}</dd>
                  </>
                )}
                {project.data.affiliation && (
                  <>
                    <dt>Affiliation</dt>
                    <dd>{project.data.affiliation}</dd>
                  </>
                )}
              </dl>
            )
          }
          {
            showDate && (
              <p class="text-muted-foreground/70 mt-2 flex items-center gap-x-1.5 text-xs">
                <Icon name="lucide:calendar" class="size-3" />
                <span>
                  {formatProjectRange()}
                </span>
              </p>
            )
          }
          {
            project.data.tags && (
              <div class="mt-2 flex flex-wrap gap-2">
                {project.data.tags.map((tag: string) => (
                  <Badge variant="muted">{tag}</Badge>
                ))}
              </div>
            )
          }
        </div>
      </Link>
    )
  }
</div>
